/**
 * Quick Start Script for LIVE RUSSIA Tester Dashboard
 * ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
 */

const { exec, spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

// Colors for console output
const colors = {
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  reset: '\x1b[0m',
  bold: '\x1b[1m'
};

const log = {
  success: (msg) => console.log(`${colors.green}âœ… ${msg}${colors.reset}`),
  error: (msg) => console.log(`${colors.red}âŒ ${msg}${colors.reset}`),
  warning: (msg) => console.log(`${colors.yellow}âš ï¸  ${msg}${colors.reset}`),
  info: (msg) => console.log(`${colors.blue}â„¹ï¸  ${msg}${colors.reset}`),
  header: (msg) => console.log(`${colors.bold}${colors.blue}\n=== ${msg} ===${colors.reset}`)
};

/**
 * Execute command and return promise
 */
function execCommand(command, options = {}) {
  return new Promise((resolve, reject) => {
    exec(command, options, (error, stdout, stderr) => {
      if (error) {
        reject({ error, stdout, stderr });
      } else {
        resolve({ stdout, stderr });
      }
    });
  });
}

/**
 * Check if .env file exists and create if needed
 */
function setupEnvFile() {
  log.header('ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°');
  
  if (!fs.existsSync('.env')) {
    if (fs.existsSync('.env.example')) {
      fs.copyFileSync('.env.example', '.env');
      log.success('.env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· .env.example');
      log.warning('ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…');
      return false; // Need manual configuration
    } else {
      log.error('.env.example Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
      return false;
    }
  } else {
    log.success('.env Ñ„Ð°Ð¹Ð» ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚');
    return true;
  }
}

/**
 * Install dependencies
 */
async function installDependencies() {
  log.header('Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹');
  
  if (!fs.existsSync('node_modules')) {
    try {
      log.info('Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° npm Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹...');
      await execCommand('npm install');
      log.success('Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹');
      return true;
    } catch (error) {
      log.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹: ' + error.error?.message);
      return false;
    }
  } else {
    log.success('Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹');
    return true;
  }
}

/**
 * Run database migrations
 */
async function runMigrations() {
  log.header('Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…');
  
  try {
    const { stdout } = await execCommand('node backend/db/run-migrations.js');
    log.success('ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾');
    return true;
  } catch (error) {
    log.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹');
    console.log(error.stderr || error.stdout);
    return false;
  }
}

/**
 * Create admin user
 */
async function createAdmin() {
  log.header('Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°');
  
  try {
    const { stdout } = await execCommand('node backend/db/seed-admin.js');
    log.success('ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð»Ð¸ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚');
    return true;
  } catch (error) {
    if (error.stdout && error.stdout.includes('already exists')) {
      log.info('ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚');
      return true;
    }
    log.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°');
    console.log(error.stderr || error.stdout);
    return false;
  }
}

/**
 * Run checkpoint verification
 */
async function runCheckpoint() {
  log.header('Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹');
  
  try {
    const { stdout } = await execCommand('node checkpoint-verification.js');
    console.log(stdout);
    log.success('ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°');
    return true;
  } catch (error) {
    log.warning('ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸');
    console.log(error.stdout || error.stderr);
    return false;
  }
}

/**
 * Start the server
 */
function startServer() {
  log.header('Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°');
  
  log.info('Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸...');
  log.info('Ð¡ÐµÑ€Ð²ÐµÑ€ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://localhost:3000');
  log.info('Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C');
  
  // Start server with npm run dev
  const serverProcess = spawn('npm', ['run', 'dev'], {
    stdio: 'inherit',
    shell: true
  });
  
  serverProcess.on('error', (error) => {
    log.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°: ' + error.message);
  });
  
  // Handle graceful shutdown
  process.on('SIGINT', () => {
    log.info('\nÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°...');
    serverProcess.kill('SIGINT');
    process.exit(0);
  });
  
  return serverProcess;
}

/**
 * Main quick start function
 */
async function quickStart() {
  console.log(`${colors.bold}${colors.blue}`);
  console.log('ðŸš€ LIVE RUSSIA Tester Dashboard - Quick Start');
  console.log('=============================================');
  console.log(`${colors.reset}`);
  
  // Step 1: Setup environment
  const envReady = setupEnvFile();
  if (!envReady) {
    log.error('ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ½Ð¾Ð²Ð°');
    log.info('ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸ Ð²Ð°ÑˆÐµÐ¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…');
    process.exit(1);
  }
  
  // Step 2: Install dependencies
  const depsInstalled = await installDependencies();
  if (!depsInstalled) {
    log.error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸');
    process.exit(1);
  }
  
  // Step 3: Run migrations
  const migrationsRun = await runMigrations();
  if (!migrationsRun) {
    log.error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…');
    log.info('Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ PostgreSQL Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð² .env ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹');
    process.exit(1);
  }
  
  // Step 4: Create admin
  const adminCreated = await createAdmin();
  if (!adminCreated) {
    log.warning('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°, Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼...');
  }
  
  // Step 5: Run checkpoint
  log.info('Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹...');
  await runCheckpoint();
  
  // Step 6: Start server
  log.header('Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ð·Ð°Ð¿ÑƒÑÐºÑƒ!');
  log.success('ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾');
  log.info('Ð£Ñ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ:');
  log.info('  Username: admin');
  log.info('  Password: admin123');
  log.warning('Ð¡Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð²Ñ…Ð¾Ð´Ð°!');
  
  console.log('\n' + '='.repeat(50));
  log.info('ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÑÑÑ‹Ð»ÐºÐ¸:');
  log.info('  Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°: http://localhost:3000');
  log.info('  Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð²Ñ…Ð¾Ð´Ð°: http://localhost:3000/login.html');
  log.info('  ÐÐ´Ð¼Ð¸Ð½ Ð¿Ð°Ð½ÐµÐ»ÑŒ: http://localhost:3000/dashboard.html');
  log.info('  API Health: http://localhost:3000/api/health');
  console.log('='.repeat(50));
  
  // Ask user if they want to start the server
  console.log('\nÐ—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€ ÑÐµÐ¹Ñ‡Ð°Ñ? (y/n)');
  
  process.stdin.setRawMode(true);
  process.stdin.resume();
  process.stdin.on('data', (key) => {
    const input = key.toString().toLowerCase();
    
    if (input === 'y' || input === '\r' || input === '\n') {
      process.stdin.setRawMode(false);
      process.stdin.pause();
      startServer();
    } else if (input === 'n') {
      process.stdin.setRawMode(false);
      process.stdin.pause();
      log.info('Ð”Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: npm run dev');
      process.exit(0);
    } else if (input === '\u0003') { // Ctrl+C
      process.stdin.setRawMode(false);
      process.stdin.pause();
      process.exit(0);
    }
  });
}

// Handle errors
process.on('unhandledRejection', (error) => {
  log.error('Unhandled error: ' + error.message);
  process.exit(1);
});

// Run quick start
if (require.main === module) {
  quickStart().catch(error => {
    log.error('Quick start failed: ' + error.message);
    process.exit(1);
  });
}

module.exports = { quickStart };